services:
  # ===========================
  # ðŸ”¹ MySQL para users-api
  # ===========================
  mysql-users:
    image: mysql:8.0
    container_name: mysql-users
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: usersdb
      MYSQL_USER: user
      MYSQL_PASSWORD: userpass
    ports:
      - "3307:3306"
    volumes:
      - mysql_users_data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-proot" ]
      interval: 5s
      timeout: 3s
      retries: 15
    restart: unless-stopped

  # ===========================
  # ðŸ”¹ MySQL para rooms-api
  # ===========================
  mysql-rooms:
    image: mysql:8.0
    container_name: mysql-rooms
    environment:
      MYSQL_ROOT_PASSWORD: rootrooms
      MYSQL_DATABASE: roomsdb
      MYSQL_USER: roomsuser
      MYSQL_PASSWORD: roomspass
    ports:
      - "3308:3306"
    volumes:
      - mysql_rooms_data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-prootrooms" ]
      interval: 5s
      timeout: 3s
      retries: 15
    restart: unless-stopped

  # ===========================
  # ðŸ”¹ Base de datos MongoDB (solo para reservations)
  # ===========================
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: rootpass
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 5s
      timeout: 3s
      retries: 15

  # ===========================
  # ðŸ”¹ RabbitMQ para eventos
  # ===========================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  # ===========================
  # ðŸ”¹ Apache Solr para bÃºsqueda
  # ===========================
  solr:
    image: solr:9.5
    container_name: solr
    restart: always
    ports:
      - "8983:8983"
    volumes:
      - solr_data:/var/solr
      - ./services/search-api/scripts/solr-init.sh:/docker-entrypoint-initdb.d/solr-init.sh
    environment:
      - SOLR_HEAP=512m
    command:
      - solr-precreate
      - rooms-core
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr/rooms-core/admin/ping"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ===========================
  # ðŸ”¹ Memcached para cachÃ©
  # ===========================
  memcached:
    image: memcached:1.6-alpine
    container_name: memcached
    restart: always
    ports:
      - "11211:11211"
    command: memcached -m 64

  # ===========================
  # ðŸ”¹ Microservicio Users API
  # ===========================
  users-api:
    build: ./services/users-api
    container_name: users-api
    environment:
      - DB_HOST=mysql-users
      - DB_PORT=3306
      - DB_USER=user
      - DB_PASSWORD=userpass
      - DB_NAME=usersdb
      - JWT_SECRET=supersecreto_cÃ¡mbialo
      - MEMCACHED_HOST=memcached
      - MEMCACHED_PORT=11211
      - MEMCACHED_TTL=600
    depends_on:
      mysql-users:
        condition: service_healthy
      memcached:
        condition: service_started
    ports:
      - "8080:8080"
    restart: unless-stopped

  # ===========================
  # ðŸ”¹ Microservicio Rooms API (MySQL)
  # ===========================
  rooms-api:
    build:
      context: ./services/rooms-api
      dockerfile: dockerfile
    container_name: rooms-api
    restart: always
    depends_on:
      mysql-rooms:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      - DB_HOST=mysql-rooms
      - DB_PORT=3306
      - DB_USER=roomsuser
      - DB_PASSWORD=roomspass
      - DB_NAME=roomsdb
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - MEMCACHED_HOST=memcached
      - MEMCACHED_PORT=11211
      - MEMCACHED_TTL=300
    ports:
      - "8081:8080"

  # ===========================
  # ðŸ”¹ Microservicio Reservations API (MongoDB + RabbitMQ)
  # ===========================
  reservations-api:
    build:
      context: ./services/reservations-api
      dockerfile: dockerfile
    container_name: reservations-api
    restart: always
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      MONGO_URI: "mongodb://root:rootpass@mongodb:27017/?authSource=admin"
      MONGO_DB_NAME: "mongodb"
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
    ports:
      - "8082:8080"

  # ===========================
  # ðŸ”¹ Microservicio Search API (Solr + Memcached + RabbitMQ)
  # ===========================
  search-api:
    build:
      context: ./services/search-api
      dockerfile: Dockerfile
    container_name: search-api
    restart: always
    depends_on:
      solr:
        condition: service_healthy
      memcached:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      rooms-api:
        condition: service_started
    environment:
      - SOLR_URL=http://solr:8983/solr
      - SOLR_CORE=rooms-core
      - MEMCACHED_HOST=memcached
      - MEMCACHED_PORT=11211
      - LOCAL_CACHE_TTL_SECONDS=60
      - DISTRIBUTED_CACHE_TTL_SECONDS=300
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - ROOMS_API_BASE_URL=http://rooms-api:8080
      - JWT_SECRET=supersecreto_cÃ¡mbialo
      - PORT=8083
      - GIN_MODE=release
    ports:
      - "8083:8083"

volumes:
  mysql_users_data:
  mysql_rooms_data:
  mongo_data:
  rabbitmq_data:
  solr_data: